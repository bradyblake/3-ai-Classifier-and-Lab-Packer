<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revolutionary Classifier - Pipeline Debugger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .pipeline-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .step-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid;
            transition: transform 0.2s;
        }
        
        .step-card:hover {
            transform: translateY(-2px);
        }
        
        .step-1 { border-left-color: #FF6B6B; }
        .step-2 { border-left-color: #4ECDC4; }
        .step-3 { border-left-color: #45B7D1; }
        
        .step-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .step-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .upload-area:hover {
            border-color: #4ECDC4;
        }
        
        .upload-area.dragover {
            border-color: #4ECDC4;
            background-color: #f0f9ff;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .btn-step-1 {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
        }
        
        .btn-step-2 {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
        }
        
        .btn-step-3 {
            background: linear-gradient(135deg, #45B7D1, #2E86AB);
        }
        
        .results-area {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }
        
        .results-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .result-content {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
            color: #495057;
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hidden {
            display: none;
        }
        
        .current-file {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 500;
            color: #1565c0;
        }

        .json-viewer {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Manual Entry Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 1200px;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 20px;
            position: relative;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .modal-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .btn-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .modal-body {
            padding: 20px;
        }

        .sds-viewer {
            margin-bottom: 20px;
        }

        .sds-image-container {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .missing-datapoints {
            margin-bottom: 20px;
        }

        .datapoint-entry {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .datapoint-label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .datapoint-description {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .datapoint-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .critical-datapoint {
            border-left: 4px solid #dc3545;
        }

        .modal-actions {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ Revolutionary Classifier Pipeline Debugger</h1>
            <p>Step-by-step debugging of PDF ‚Üí Text ‚Üí JSON ‚Üí Classification</p>
        </div>
        
        <div class="content">
            <div class="upload-area" id="uploadArea">
                <h3>üìÑ Select or Drop PDF File</h3>
                <p>Upload a PDF file to debug the extraction pipeline</p>
                <input type="file" id="fileInput" accept=".pdf" style="display: none;">
            </div>
            
            <div id="currentFile" class="current-file hidden">
                üìÑ Current File: <span id="fileName"></span>
            </div>
            
            <div class="pipeline-steps">
                <div class="step-card step-1">
                    <div class="step-title">Step 1: PDF ‚Üí Text Extraction</div>
                    <div class="step-description">
                        Extract raw text from PDF using Python PyMuPDF with Unicode handling
                    </div>
                    <button class="btn btn-step-1" id="step1Btn" disabled>üìÑ Extract Text</button>
                    
                    <div id="step1Results" class="results-area hidden">
                        <div class="results-title">üìÑ Extracted Text Preview</div>
                        <div id="step1Content" class="result-content"></div>
                    </div>
                </div>
                
                <div class="step-card step-2">
                    <div class="step-title">Step 2: Text ‚Üí JSON Conversion</div>
                    <div class="step-description">
                        Convert extracted text to structured JSON using jsonSDSExtractor
                    </div>
                    <button class="btn btn-step-2" id="step2Btn" disabled>üîÑ Convert to JSON</button>
                    
                    <div id="step2Results" class="results-area hidden">
                        <div class="results-title">üìã Structured JSON Data</div>
                        <div id="step2Content" class="json-viewer"></div>
                    </div>
                </div>
                
                <div class="step-card step-3">
                    <div class="step-title">Step 3: Revolutionary Classification</div>
                    <div class="step-description">
                        Apply Revolutionary Classifier engine for waste code classification
                    </div>
                    <button class="btn btn-step-3" id="step3Btn" disabled>üéØ Classify</button>
                    
                    <div id="step3Results" class="results-area hidden">
                        <div class="results-title">üéØ Classification Results</div>
                        <div id="step3Content" class="json-viewer"></div>
                    </div>
                </div>
            </div>
            
            <div id="statusArea"></div>
            
            <!-- Manual Entry Modal -->
            <div id="manualEntryModal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üîß Manual Data Entry Required</h2>
                        <p>Some critical datapoints were not extracted automatically. Please help by entering them manually.</p>
                        <button class="btn-close" onclick="closeManualEntry()">√ó</button>
                    </div>
                    
                    <div class="modal-body">
                        <div class="sds-viewer">
                            <div class="sds-image-container">
                                <iframe id="sdsViewer" src="" width="100%" height="400px" style="border: 1px solid #ccc; border-radius: 6px;"></iframe>
                            </div>
                        </div>
                        
                        <div id="missingDatapoints" class="missing-datapoints">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                        
                        <div class="modal-actions">
                            <button class="btn btn-success" onclick="submitManualData()">‚úÖ Save Manual Data</button>
                            <button class="btn btn-secondary" onclick="skipManualEntry()">‚è≠Ô∏è Skip Manual Entry</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFile = null;
        let extractedText = null;
        let structuredData = null;

        // File handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const currentFileDiv = document.getElementById('currentFile');
        const fileName = document.getElementById('fileName');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        // Step buttons
        document.getElementById('step1Btn').addEventListener('click', () => executeStep1());
        document.getElementById('step2Btn').addEventListener('click', () => executeStep2());
        document.getElementById('step3Btn').addEventListener('click', () => executeStep3());

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                setCurrentFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                setCurrentFile(e.target.files[0]);
            }
        }

        function setCurrentFile(file) {
            currentFile = file;
            fileName.textContent = file.name;
            currentFileDiv.classList.remove('hidden');
            document.getElementById('step1Btn').disabled = false;
            
            // Reset pipeline state
            extractedText = null;
            structuredData = null;
            document.getElementById('step2Btn').disabled = true;
            document.getElementById('step3Btn').disabled = true;
            hideAllResults();
            
            showStatus('üìÑ File selected: ' + file.name, 'success');
        }

        function hideAllResults() {
            document.getElementById('step1Results').classList.add('hidden');
            document.getElementById('step2Results').classList.add('hidden');
            document.getElementById('step3Results').classList.add('hidden');
        }

        function showStatus(message, type) {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => statusArea.innerHTML = '', 5000);
        }

        async function executeStep1() {
            if (!currentFile) return;

            showStatus('üîÑ Step 1: Extracting text from PDF...', 'loading');
            
            const formData = new FormData();
            formData.append('pdf', currentFile);

            try {
                const response = await fetch('/api/extract-pdf', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    extractedText = result.text;
                    document.getElementById('step1Content').textContent = 
                        `Length: ${result.length} characters\n\nFirst 2000 characters:\n${result.text.substring(0, 2000)}...`;
                    document.getElementById('step1Results').classList.remove('hidden');
                    document.getElementById('step2Btn').disabled = false;
                    showStatus(`‚úÖ Step 1 Complete: ${result.length} characters extracted`, 'success');
                } else {
                    showStatus(`‚ùå Step 1 Failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Step 1 Error: ${error.message}`, 'error');
            }
        }

        async function executeStep2() {
            if (!extractedText) return;

            showStatus('üîÑ Step 2: Converting text to structured JSON...', 'loading');

            try {
                const response = await fetch('/api/text-to-json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: extractedText })
                });

                const result = await response.json();
                
                if (result.success) {
                    structuredData = result.data;
                    document.getElementById('step2Content').textContent = JSON.stringify(result.data, null, 2);
                    document.getElementById('step2Results').classList.remove('hidden');
                    
                    // Check for missing critical datapoints
                    if (result.data.validation && result.data.validation.needsManualEntry) {
                        showStatus(`‚ö†Ô∏è Step 2 Complete: Missing critical data - Manual entry required`, 'loading');
                        showManualEntryModal(result.data.validation.missingDatapoints);
                    } else {
                        document.getElementById('step3Btn').disabled = false;
                        showStatus(`‚úÖ Step 2 Complete: JSON structure created`, 'success');
                    }
                } else {
                    showStatus(`‚ùå Step 2 Failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Step 2 Error: ${error.message}`, 'error');
            }
        }

        async function executeStep3() {
            if (!extractedText || !structuredData) return;

            showStatus('üîÑ Step 3: Applying Revolutionary Classification...', 'loading');

            try {
                const response = await fetch('/api/classify-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        text: extractedText,
                        structuredData: structuredData
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('step3Content').textContent = JSON.stringify(result, null, 2);
                    document.getElementById('step3Results').classList.remove('hidden');
                    showStatus(`‚úÖ Step 3 Complete: Classification finished`, 'success');
                } else {
                    showStatus(`‚ùå Step 3 Failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Step 3 Error: ${error.message}`, 'error');
            }
        }

        // Manual Entry Modal Functions
        function showManualEntryModal(missingDatapoints) {
            const modal = document.getElementById('manualEntryModal');
            const missingContainer = document.getElementById('missingDatapoints');
            const sdsViewer = document.getElementById('sdsViewer');
            
            // Display the PDF in the viewer
            if (currentFile) {
                const fileURL = URL.createObjectURL(currentFile);
                sdsViewer.src = fileURL;
            }
            
            // Generate form fields for missing datapoints
            let formHTML = '<h3>Missing Datapoints:</h3>';
            
            missingDatapoints.forEach((datapoint, index) => {
                const criticalClass = datapoint.critical ? 'critical-datapoint' : '';
                const criticalLabel = datapoint.critical ? ' (Required)' : ' (Optional)';
                
                formHTML += `
                    <div class="datapoint-entry ${criticalClass}">
                        <div class="datapoint-label">${datapoint.label}${criticalLabel}</div>
                        <div class="datapoint-description">${datapoint.description}</div>
                        <input type="text" class="datapoint-input" 
                               data-field="${datapoint.field}" 
                               placeholder="Enter ${datapoint.label.toLowerCase()}..."
                               id="manual-${datapoint.field}">
                    </div>
                `;
            });
            
            missingContainer.innerHTML = formHTML;
            modal.classList.remove('hidden');
        }

        function closeManualEntry() {
            document.getElementById('manualEntryModal').classList.add('hidden');
        }

        function skipManualEntry() {
            closeManualEntry();
            document.getElementById('step3Btn').disabled = false;
            showStatus(`‚è≠Ô∏è Manual entry skipped - Proceeding with available data`, 'success');
        }

        function submitManualData() {
            const inputs = document.querySelectorAll('.datapoint-input');
            const manualData = {};
            
            inputs.forEach(input => {
                if (input.value.trim()) {
                    manualData[input.dataset.field] = input.value.trim();
                }
            });
            
            // Merge manual data with existing structured data
            if (Object.keys(manualData).length > 0) {
                // Update structured data with manual entries
                if (manualData.productName) {
                    structuredData.productName = manualData.productName;
                }
                
                if (manualData.composition) {
                    // Parse composition entry (expect format like "Acetone 67-64-1")
                    const compParts = manualData.composition.split(' ');
                    if (compParts.length >= 2) {
                        const name = compParts.slice(0, -1).join(' ');
                        const cas = compParts[compParts.length - 1];
                        if (!structuredData.composition) structuredData.composition = [];
                        structuredData.composition.push({
                            name: name,
                            cas: cas,
                            percentage: null,
                            source: 'manual'
                        });
                    }
                }
                
                // Update other fields as needed
                Object.keys(manualData).forEach(field => {
                    if (field !== 'productName' && field !== 'composition') {
                        structuredData[field] = manualData[field];
                    }
                });
                
                // Re-display updated data
                document.getElementById('step2Content').textContent = JSON.stringify(structuredData, null, 2);
                
                showStatus(`‚úÖ Manual data saved - ${Object.keys(manualData).length} fields updated`, 'success');
            }
            
            closeManualEntry();
            document.getElementById('step3Btn').disabled = false;
        }
    </script>
</body>
</html>